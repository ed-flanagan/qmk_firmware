/* Copyright 2025 Ed Flanagan
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

#include "quantum.h"

#ifdef OLED_ENABLE

/*
 * 1024 bytes, 8x8 font, 128 characters, 128x64 image, 16 columns, 8 rows
 *
 * The oled screen is represented by 8x8 "bit blocks". Each byte represents
 * 8 "column" bits within a given block. I.e. the 128x64 display is
 * 8 rows with 16 columns. Each block contains 8 bytes (64 bits).
 *
 * The raw format is (singular) array of bytes. A given byte in the list
 * is positional to it's respective location in the actual display.
 * It simply iterates each "bit block" across each column, "wrapping" at
 * the end of each row, i.e. `i % 128` is it's column and `i // 8` is row
 *
 * <row.col.vert>
 * ┌───────────────────────┬─────┬─────────────────────┐
 * │ 0.0.0 0.1.0 ... 0.7.0 │ ... │ 0.119.0 ... 0.127.0 │
 * │   .         .         │     │         .           │
 * │   .          .        │     │          .          │
 * │   .           .       │     │           .         │
 * │ 0.0.7       ... 0.7.7 │     │ 0.119.7 ... 0.127.7 │
 * ├───────────────────────┼─────┼─────────────────────┤
 * │ ...                   │ ... │ ...                 │
 * ├───────────────────────┼─────┼─────────────────────┤
 * │ 7.0.0 7.1.0 ... 7.7.0 │ ... │ 7.119.0 ... 7.127.0 │
 * │   .         .         │     │         .           │
 * │   .          .        │     │          .          │
 * │   .           .       │     │           .         │
 * │ 7.0.7       ... 7.7.7 │     │ 7.119.7 ... 7.127.7 │
 * └───────────────────────┴─────┴─────────────────────┘
 */

static void render_haute42_logo(void) {
    static const char PROGMEM haute42_logo_raw[] = {
        // clang-format off

        0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,128,192,224,224,192,192,128,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,192,192,224,240,240,248,248,252,254,254,255,255,255,255,255,255,255,255,255,255,255,255,254,254,252,248,  0,  0,  0,  0,224,224,192,192,128,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,248,248,240,240,224,224,193,193,131,  7,  7, 15, 15, 31,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,  0,  0,  0,  0,255,255,255,255,255,255,255,255,254,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255,255,255,255,255,255,255,255,255,  0,  0,  0,  0,  0,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,  0,  0,  0,  0,255,255,255,255,255,255,255,255,255,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255,255,255,255,255,255,255,255,255,  0,  0,  0,  0,  0,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,  0,  0,  0,  0,255,255,255,255,255,255,255,255,255,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 63,127,127,255,255,255,255,255,255,  0,  0,  0,  0,  0,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,248,240,224,224,192,193,129,131,  3,  7,  7, 15, 15,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  3,  3,  0,  0,  0,  0,  0, 63,127,127,255,255,255,255,255,255,255,255,255,255,255,255,127,127, 63, 63, 31, 31, 15,  7,  7,  3,  3,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  3,  7,  7,  3,  3,  1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,

        // clang-format on
    };

    oled_write_raw_P(haute42_logo_raw, sizeof(haute42_logo_raw));
}

static void render_tuco_logo(void) {
    static const char PROGMEM tuco_logo_raw[] = {
        // clang-format off

        // Row 0, cols 0-15 -- all black
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,

        // Row 1, cols 0-15 -- all black
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,

        // Rows 2-5, cols 0-15 -- logo
          0,   0,   0,   0,   0,   0,   0,   0, // First block is black
          0,   0,   0, 128, 192,  96,  48, 152,
        204, 230, 243, 249, 249, 249, 249, 249,
        249, 249, 249, 249, 249, 249, 241, 225,
        193, 137,  25,  57, 121, 249, 249, 121,
        249, 249, 249, 249, 241, 227, 198, 140,
         24,  48,  24, 140, 198, 227, 241, 249,
        249, 249, 249, 249, 249, 249, 121,  57,
        249, 249, 249, 249, 249, 249, 249, 249,
        249,   1,   1,  31, 152, 204, 230, 243,
        249, 249, 249, 249, 249, 249, 249, 121,
         57,  25, 137, 193, 225, 241, 249, 249,
        249, 249, 249, 249, 249, 249, 249, 249,
        249, 249, 249, 249, 249, 249, 249, 249,
        249, 241, 227, 198, 140,  24,  48,  96,
        192, 128,   0,  0 ,  0 ,   0,   0,   0, // Most of last block is black

          0,   0,   0, 128, 192, 224, 176, 152,
        140, 134, 147, 153, 156, 158, 159, 159,
        159, 159, 159,  31,  31, 143, 199, 227,
        243, 251, 255, 255, 255, 255, 255, 255,
        127,  63,  31,  14,   4,   0,   1,   3,
          4,   3,   7, 143, 223, 255, 255, 255,
        255, 254, 255, 255, 255, 255, 127,  63,
         31,  15,   7,   3,   1,   0,   0,   0,
        255, 255, 255, 255, 255, 255, 255, 255,
        255, 252, 254, 255, 255, 255, 255, 223,
        159,  31,  15,  71, 227, 241, 248, 252,
        254, 255, 255, 255, 255, 255, 191,  31,
         15,   7,   3,   1,   1,   1,   1,   1,
          1,   1,   1, 129, 195, 231, 255, 255,
        255, 255, 255, 255, 255, 255, 126,  60,
        152, 193, 227, 182,  28,   0,   0,   0,

          0,   0,   0,   4,   6,   7,   7,   7, // Note that most edge blocks are black, i.e. where image starts
          7, 135, 199, 103,  55, 159, 207, 231,
        243, 249, 252, 254, 255, 255, 255, 255,
        255, 255, 255, 255, 247, 243, 241, 240,
        240, 240, 224, 192, 192, 224, 240, 248,
        252, 254, 255, 255, 255, 255, 127,  63,
         31, 143,  31,  63, 127, 255, 255, 254,
        252, 248, 228, 216, 240, 224, 192, 128,
         31,  63, 127, 255, 255, 255, 255, 255,
        255,   7,  15,  31,  63, 127, 255, 255,
        255, 255, 254, 252, 248, 241, 227, 199,
        143,  31,  63, 127, 255, 255, 255, 255,
        254, 252, 248, 240, 240, 240, 240, 248,
        252, 254, 255, 255, 255, 255, 127,  63,
        159, 207, 231, 243, 249, 124,  62,  31,
         15,   7,   3,   1,   0,   0,   0,   0,

          0,   0,   0,   0, 144, 216, 252, 246,
        243, 241, 240, 242, 243, 243, 243, 243,
        243, 243, 243, 243, 243, 243, 243, 243,
        243, 243, 243, 243, 243, 243, 243, 243,
        243, 243, 243, 243, 243, 243, 243, 243,
        243, 243, 243, 243, 241, 248, 124,  62,
         31,  15,  31,  62, 124, 248, 241, 243,
        243, 243, 243, 243, 243, 243, 243, 243,
        243, 242, 240, 240, 241, 243, 243, 243,
        243, 240, 240, 255,  30,  60, 120, 241,
        243, 243, 243, 243, 243, 243, 243, 243,
        243, 243, 242, 240, 240, 241, 243, 243,
        243, 243, 243, 243, 243, 243, 243, 243,
        243, 243, 243, 243, 249, 124,  62,  31,
         15,   7,   3,   1,   0,   0,   0,   0,
          0,   0,   0,   0,   0,   0,   0,   0,

        // Row 6, cols 0-15 -- all black
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,

        // Row 7, cols 0-15 -- all black
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,

        // clang-format on
    };

    oled_write_raw_P(tuco_logo_raw, sizeof(tuco_logo_raw));
}

static bool display_mf_logo   = true;
static bool display_game_logo = true;

// void housekeeping_task_user(void) {
bool oled_task_kb(void) {
    if (display_mf_logo) {
        render_haute42_logo();
        display_mf_logo = false;
    }

    // TODO: timer_elapsed(timer_read()) always returns 0?
    if (display_game_logo && timer_read() >= 4000) {
        oled_clear();
        render_tuco_logo();
        oled_render_dirty(true);
        display_game_logo = false;
    }

    return false;
}

void oled_render_boot(bool bootloader) {
    // TODO: better way to do this? Believe this is because we're not in an
    // oled_task callback
    if (is_oled_scrolling()) {
        oled_scroll_off();
    }
    oled_clear();
    oled_set_cursor(0, 3);
    oled_write_P(PSTR(bootloader ? "Awaiting flash..." : "Rebooting..."), false);
    oled_render_dirty(true);
}

#endif // OLED_ENABLE

// TODO: SOCD

void keyboard_post_init_user(void) {
#ifdef CONSOLE_ENABLE
    debug_enable = true;
    debug_matrix = true;
#endif

#ifdef RGB_MATRIX_ENABLE
    rgb_matrix_mode(RGB_MATRIX_CUSTOM_TXKO_SOLID);
#endif
}

bool shutdown_user(bool jump_to_bootloader) {
#ifdef OLED_ENABLE
    oled_render_boot(jump_to_bootloader);
#endif

    return false;
}
